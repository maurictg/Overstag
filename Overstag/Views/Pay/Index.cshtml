@model Overstag.Models.XInvoice
@{
    Layout = "_PayLayout";
    ViewBag.Title = "Welkom";
    ViewBag.InvoiceURL = Model.InvoiceID;
}

<div id="content">
    <div class="row">
        <div class="col s12 m2">
            <br />
            <img src="~/img/logo_2.png" class="responsive-img" />
        </div>
        <div class="col s12 m10 center-align">
            <h3>Factuur van @Model.User.Firstname @Model.User.Lastname</h3>
        </div>
    </div>
    <div class="row">
        <br />
        <ul class="collapsible expandable" id="info">
            <li>
                <div class="collapsible-header"><i class="material-icons">account_circle</i><b>Gebruikersinformatie</b></div>
                <div class="collapsible-body">
                    <table class="responsive-table">
                        <thead>
                            <tr>
                                <th>Naam</th>
                                <th>Achternaam</th>
                                <th>Email</th>
                                <th>Adres</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>@Model.User.Firstname</td>
                                <td>@Model.User.Lastname</td>
                                <td><i>@Model.User.Email</i></td>
                                <td>@Model.User.Adress&nbsp;@Model.User.Postalcode&nbsp;@Model.User.Residence</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </li>
            <li>
                <div class="collapsible-header"><i class="material-icons">calendar_today</i><b>Evenementen</b></div>
                <div class="collapsible-body">
                    <table class="responsive-table">
                        <thead>
                            <tr>
                                <th>Titel</th>
                                <th>Omschrijving</th>
                                <th>Datum en tijd</th>
                                <th>Vrienden mee?</th>
                                <th>Kosten</th>
                                <th>Totaal</th>
                            </tr>
                        </thead>
                        <tbody>
                            @{ int total = Model.AdditionsCost;}
                            @foreach (var e in Model.Events)
                            {
                                <tr>
                                    <td>@e.Key.Title</td>
                                    <td>@string.Concat(e.Key.Description.Take(30))@((e.Key.Description.Length>30)?"...":"")</td>
                                    <td>@e.Key.When.ToString("dd-MM-yyyy") om @e.Key.When.ToString("HH:mm")</td>
                                    <td>
                                        @if (e.Value > 0)
                                        {
                                            @Html.Raw($"Ja, <b>{e.Value}</b>, (+&euro;{Math.Round((double)(e.Key.Cost * e.Value) / 100, 2).ToString("F")})")
                                        }
                                        else
                                        {
                                            @Html.Raw("Nee")
                                        }
                                    </td>
                                    <td>&euro;@Math.Round((double)e.Key.Cost / 100, 2).ToString("F")</td>
                                    <td><b>&euro;@Math.Round((double)e.Key.Cost * (e.Value + 1) / 100, 2).ToString("F")</b></td>
                                </tr>
                                total += (e.Key.Cost * (e.Value + 1));
                            }
                            <tr>
                                <td colspan="6">
                                    @if (Model.AdditionsCost > 0)
                                    {
                                        <p>Een aantal drankjes gekocht met een totale waarde van <b>&euro;@Math.Round((double)Model.AdditionsCost / 100, 2).ToString("F")</b></p>
                                    }
                                    else
                                    {
                                        <p>Geen drankjes gekocht.</p>
                                    }
                                </td>
                            </tr>
                            <tr>
                                <td colspan="6" class="grey darken-1 white-text">
                                    <h6>Totaal: <b>&euro;@Math.Round((double)total / 100, 2).ToString("F")</b> @((Model.AdditionsCost>0)?"(inclusief drankjes)":"")</h6>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </li>
            <li>
                <div class="collapsible-header"><i class="material-icons">description</i><b>Factuurdetails</b></div>
                <div class="collapsible-body">
                    <table class="responsive-table">
                        <thead>
                            <tr>
                                <th>Datum</th>
                                <th>Tijd</th>
                                <th>Factuurkenmerk</th>
                                <th>Totaalbedrag</th>
                                <th>Betaald</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>@Model.Timestamp.ToString("dd-MM-yyyy")</td>
                                <td>@Model.Timestamp.ToString("HH:mm:ss")</td>
                                <td><i>@Model.InvoiceID</i></td>
                                <td><b>&euro;@Math.Round((double)Model.Amount / 100, 2).ToString("F")</b></td>
                                <td><b class="@Html.Raw((Model.Payed) ? "green-text" : "red-text")">@Html.Raw((Model.Payed) ? "Ja" : "Nee")</b></td>
                            </tr>
                        </tbody>
                    </table>

                    @if (ViewBag.Payment != null)
                    {
                        Overstag.Models.Payment p = ViewBag.Payment;
                        DateTime dt = p.PayedAt ?? new DateTime(2000, 1, 1);
                        bool validated = (Model.Payed == (p.PayedAt != null && !string.IsNullOrEmpty(p.PaymentID) && p.Invoice.InvoiceID == Model.InvoiceID && Convert.ToInt32(p.Status) == 6));
                        <br />
                        <table class="responsive-table">
                            <thead>
                                <tr>
                                    <th>Betalingskenmerk</th>
                                    <th>Geplaatst op</th>
                                    <th>Betaald op</th>
                                    <th>Betaling gevalideerd</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><b>@p.PaymentID</b></td>
                                    <td>@p.PlacedAt.ToString("dd-MM-yyyy hh:mm:ss")</td>
                                    <td>@dt.ToString("dd-MM-yyyy hh:mm:ss")</td>
                                    <td><b class="@Html.Raw((validated) ? "green-text" : "red-text")">@Html.Raw((validated) ? "Ja" : "Nee")</b></td>
                                </tr>
                            </tbody>
                        </table>
                        @Html.Raw((!validated) ? "<h5 class=\"red-text\">Er is iets fout gegaan met de validatie. Neem a.u.b. contact op met de beheerder</h5>" : "");
                    }
                    else
                    {
                        if (Model.Payed)
                        {
                            @Html.Raw("<h5 class=\"red-text\">Er is iets fout gegaan met de validatie. Neem a.u.b. contact op met de beheerder</h5>")
                        }
                    }
                    <br />
                    <h6 id="printed_at" style="display: none;">Factuur geprint op: <b>@DateTime.Now.ToString("dd-MM-yyyy")&nbsp;om&nbsp;@DateTime.Now.ToString("HH:mm:ss")</b></h6>
                </div>
            </li>
        </ul>
    </div>

    <div class="row">
        <div class="col s12 center-align">
            <button class="btn btn-large green waves-effect" id="btnprint" onclick="Invoice.startPrint();">Printen</button>
            @if (!Model.Payed)
            {
                <button class="btn btn-large blue waves-effect" id="btnnext" onclick="Invoice.checkout();">Betalen &rarr;</button>
            }
        </div>
    </div>
</div>

<form id="frmCheckout" style="display: none;" method="post" action="/Pay/Checkout">
    <input name="invoiceid" value="@Uri.EscapeDataString(Model.InvoiceID)" />
</form>

<script>
    var invoiceid = '@Uri.EscapeDataString(Model.InvoiceID)';
    var cancelPayment = true;

    var Invoice = {
        init: function () {
            $('#_invoice, #_minvoice').addClass('active');
            M.Collapsible.getInstance($('#info')).open(2);
        },
        startPrint: function () {
            var elem = document.querySelector('.collapsible.expandable');
            var instance = M.Collapsible.init(elem, { accordion: false });
            instance.open(0); instance.open(1); instance.open(2);
            $('nav, #btnprint, #btnnext').hide();
            M.toast({ html: "Printen...", classes: "blue rounded", displayLength: 500, completeCallback: function() { Invoice.doPrint() } });
        },
        doPrint: function () {
            window.print();
            $('nav, #btnprint, #btnnext').show();
            var elem = document.querySelector('.collapsible.expandable');
            var instance = M.Collapsible.init(elem, { accordion: true });
            instance.close(0); instance.close(1); instance.close(2);
            $('#printedat').hide();
        },
        checkout: function () {
            $('#_progbar').show();
            $('#frmCheckout').submit();
            setTimeout(Invoice.hidePB, 10000);
        },
        hidePB: function () {
            $('#_progbar').hide();
        }
    };

    $(function () {
        $('.collapsible').collapsible();
        Invoice.init();
    });
</script>